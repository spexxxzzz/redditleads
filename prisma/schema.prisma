generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                    @id @default(cuid())
  email                   String                    @unique
  firstName               String?
  lastName                String?
  plan                    String                    @default("basic")
  subscriptionStatus      String?                   @default("inactive")
  subscriptionStartDate   DateTime?
  subscriptionEndDate     DateTime?
  lastKarmaCheck          DateTime?
  redditKarma             Int?                      @default(0)
  redditRefreshToken      String?
  redditUsername          String?
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  redditAuthState         String?                   @unique
  hasConnectedReddit      Boolean                   @default(false)
  AIUsage                 AIUsage[]
  projects                Project[]
  leads                   Lead[]
  MarketInsight           MarketInsight[]
  scheduledReplies        ScheduledReply[]
  webhooks                Webhook[]
  emailNotificationSetting EmailNotificationSetting?
  paymentTransactions     PaymentTransaction[]
  subscriptionHistory     SubscriptionHistory[]
  billingAddress          BillingAddress?
  invoices                Invoice[]
}
// âœ¨ NEW MODEL ADDED FOR EMAIL NOTIFICATIONS âœ¨
model EmailNotificationSetting {
  id      String  @id @default(cuid())
  email   String
  enabled Boolean @default(false)
  userId  String  @unique // Each user has one setting
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model NewsletterSubscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  subscribedAt DateTime @default(now())
  isActive  Boolean  @default(true)
  source    String?  @default("blog") // Track where they subscribed from
}

model Webhook {
  id               String    @id @default(cuid())
  name             String
  url              String
  type             String
  isActive         Boolean   @default(true)
  events           String[]
  userId           String
  createdAt        DateTime  @default(now())
  lastTriggered    DateTime?
  lastSentAt       DateTime?
  filters          Json?
  rateLimitMinutes Int?
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("webhooks")
}

model Project {
  id                    String          @id @default(cuid())
  userId                String
  analyzedUrl           String
  generatedKeywords     String[]
  generatedDescription  String
  targetSubreddits      String[]        @default([])
  businessDNA           Json?           // ðŸ‘ˆ NEW: Store the full Business DNA object
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  competitors           String[]        @default([])
  name                  String          @default("Untitled Campaign")
  isActive              Boolean         @default(true)
  negativeKeywords      String[]        @default([])
  subredditBlacklist    String[]        @default([])
  lastManualDiscoveryAt DateTime?
  lastGlobalDiscoverAt    DateTime?
  lastTargetedDiscoveryAt  DateTime?
  // ðŸ‘ˆ NEW: Discovery Progress Tracking Fields
  discoveryStatus       String?         // 'running', 'completed', 'failed', null
  discoveryProgress     Json?           // { stage, leadsFound, message, estimatedTimeLeft }
  discoveryStartedAt    DateTime?
  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  leads                 Lead[]
  MarketInsight         MarketInsight[]

  @@index([userId])
}

model Lead {
  id                 String           @id @default(cuid())
  redditId           String
  title              String
  author             String
  subreddit          String
  url                String
  body               String?
  postedAt           DateTime
  discoveredAt       DateTime         @default(now())
  opportunityScore   Int
  status             String           @default("new")
  projectId          String
  intent             String?
  relevanceReasoning String?          // ðŸ‘ˆ NEW: Store the AI's reasoning
  userId             String
  createdAt          DateTime         @default(now())
  sentiment          String?
  type               LeadType         @default(DIRECT_LEAD)
  updatedAt          DateTime         @updatedAt
  insightAnalysisRan Boolean          @default(false)
  summary            String?
  isGoogleRanked     Boolean?         @default(false)
  project            Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  scheduledReplies   ScheduledReply[]

  @@unique([redditId, projectId])
  @@index([userId])
  @@index([projectId])
}

model ScheduledReply {
  id            String               @id @default(cuid())
  content       String
  status        ScheduledReplyStatus @default(PENDING)
  scheduledAt   DateTime?
  postedAt      DateTime?
  redditPostId  String?
  failReason    String?
  leadId        String
  userId        String
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  upvotes       Int?                 @default(0)
  authorReplied Boolean?             @default(false)
  lastCheckedAt DateTime?
  lead          Lead                 @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([leadId])
}

model SubredditProfile {
  id               String   @id @default(cuid())
  name             String   @unique
  rules            String[] @default([])
  cultureNotes     String?
  peakActivityTime String?
  lastAnalyzedAt   DateTime @updatedAt
}

model MarketInsight {
  id                       String        @id @default(cuid())
  discoveredCompetitorName String
  sourceUrl                String
  sourceTextSnippet        String
  context                  String
  status                   InsightStatus @default(NEW)
  userId                   String
  projectId                String
  discoveredAt             DateTime      @default(now())
  project                  Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user                     User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, discoveredCompetitorName])
  @@index([projectId])
  @@index([userId])
}

model AIUsage {
  id     String @id @default(cuid())
  userId String
  month  String
  type   String
  count  Int    @default(0)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, type], name: "userId_month_type")
}

// ðŸš€ NEW: Payment Transaction History
model PaymentTransaction {
  id                String   @id @default(cuid())
  userId            String
  planId            String
  amount            Decimal  @db.Decimal(10, 2)
  currency          String   @default("USD")
  status            PaymentStatus @default(PENDING)
  paymentMethod     String?
  externalId        String?  // DodoPayments transaction ID
  checkoutUrl       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  completedAt       DateTime?
  failedAt          DateTime?
  failureReason     String?
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([externalId])
  @@index([status])
}

// ðŸš€ NEW: Subscription History Tracking
model SubscriptionHistory {
  id              String   @id @default(cuid())
  userId          String
  planId          String
  action          SubscriptionAction
  previousPlanId  String?
  amount          Decimal? @db.Decimal(10, 2)
  reason          String?
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
}

// ðŸš€ NEW: Billing Information
model BillingAddress {
  id         String @id @default(cuid())
  userId     String @unique
  address    String
  city       String
  state      String?
  country    String
  postalCode String
  taxId      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ðŸš€ NEW: Invoice Management
model Invoice {
  id            String   @id @default(cuid())
  userId        String
  transactionId String
  amount        Decimal  @db.Decimal(10, 2)
  currency      String   @default("USD")
  status        InvoiceStatus @default(PENDING)
  invoiceUrl    String?
  pdfUrl        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([transactionId])
  @@index([userId])
  @@index([status])
}

enum ScheduledReplyStatus {
  PENDING
  POSTED
  FAILED
  CANCELLED
    PENDING_MANUAL_POST
}

enum LeadType {
  DIRECT_LEAD
  COMPETITOR_MENTION
}

enum InsightStatus {
  NEW
  VIEWED
  ACTIONED
  IGNORED
}

// ðŸš€ NEW: Payment and Subscription Enums
enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum SubscriptionAction {
  CREATED
  UPGRADED
  DOWNGRADED
  CANCELLED
  RENEWED
  EXPIRED
  TRIAL_STARTED
  TRIAL_ENDED
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}